# {{ ansible_managed }}

CHECK PROCESS {{ services['php-fpm']['name'] }} MATCHING "{{ services['php-fpm']['regexp'] }}"
  IF NOT EXIST FOR 1 CYCLES THEN {{ services['php-fpm']['action'] }}
{% if services['php-fpm']['action'] != "alert" %}
  REPEAT EVERY {{ services['php-fpm']['repeat_interval'] }} CYCLES
{% endif %}
{% if services['php-fpm'].get('port') %}
  IF FAILED PORT {{ services['php-fpm']['port'] }} FOR 1 CYCLES THEN alert
{% endif %}
{% if services['php-fpm'].get('socket') %}
  IF FAILED UNIXSOCKET {{ services['php-fpm']['socket'] }} FOR 1 CYCLES THEN alert
{% endif %}
  group php-fpm

{% if services['php-fpm'].get('virtual_host') %}
CHECK HOST {{ services['php-fpm']['virtual_host'] }} WITH ADDRESS 127.0.0.1
  IF FAILED
    PORT 80 PROTOCOL http
    WITH HTTP HEADERS [Host: {{ services['php-fpm']['virtual_host'] }}]
    STATUS != 502
    FOR 1 CYCLES
  THEN {{ services['php-fpm']['virtual_host_action'] }}
  depends on php-fpm
  group php-fpm
{% endif %}

